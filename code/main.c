// Welch, Wright, & Morrow, 
// Real-time Digital Signal Processing, 2011
 
///////////////////////////////////////////////////////////////////////
// Filename: main.c
//
// Synopsis: Main program file for demonstration code
//
///////////////////////////////////////////////////////////////////////

#include "DSP_Config.h"
#include "AIC3106.h"
#include <stdio.h>
#include <math.h>
#include <float.h>
#include "voiceprint.h"

#define MODEL3 2
#define MODEL4 3

volatile union {
	short st;
	Uint8 ui8[2];
} singleData;

extern int status;

extern BYTE pVoiceBuffer[g_build_buff_num][BUFFLEN];

int IdentifyResult() {
	int i, j;
	double temp[4] = {0.0, 0.0, 0.0, 0.0};
	double max_percent[4] = {0.0, 0.0, 0.0, 0.0};

	for (i = 0; i < IDENTIFY_NUM; i++) {
		for (j = 0; j < 4; j++) {
			if (voiceprint[j].voice_mdl.bValued) {
				temp[j] = fabs((voiceprint[j].voice_mdl.value[i][1] - voiceprint[j].voice_mdl.value[i][0]) / voiceprint[j].voice_mdl.value[i][0]);
				max_percent[j] = max_percent[j] < temp[j] ? temp[j] : max_percent[j];
			}
		}
	}

	// print result
	int smallestIdx = MODEL3;
	for (j = 0; j < 4; j++) {
		if (voiceprint[j].voice_mdl.bValued) {
			if (max_percent[j] < max_percent[smallestIdx]) {
				smallestIdx = j;
			}
		}
	}

	return max_percent[smallestIdx] < (PERCENT / 100.0) ? smallestIdx : -1;
}

// *******************************************************
// xinxin
double value3[IDENTIFY_NUM] = {1230.5581614477882795, 1148.9374750555641640, 1193.3904028615077095, 1021.7993878500323035};
double p3[M] = {0.3776911046822589, 0.2214723036468017, 0.1095944125939269, 0.1636973618221085, 0.1275448172549039};
double mu3[M * D] = {
	41.5895455935713159, -4.4987960411477257, -2.3020658661661346, -0.6103087466722482, -1.6988075707537298, -0.5867749768308149, -0.7802630615741421, 0.1917564301561421, -0.3196398972292806, -0.2444711032624938, -0.0449284928764557, -0.1439222888484741, -0.0267339916120406, -0.1806695287747888, 0.1137858047821985, -0.1327503606607048, -0.0990120177878461, -0.0050660874811063, -0.0746285496677551, -0.0888536299099667,
	36.2026872917977371, -4.2764760329854816, -0.0193564754725066, 0.5166340595094399, -3.2090654882110377, -1.2805890008818366, -1.1812816964755968, -0.0054761621674862, -0.4148309995328821, -0.1536229471978198, 0.2705752451312796, -0.2016307974660191, 0.2103186337342569, 0.0191692376677489, 0.2281199119595408, 0.1020981459224993, 0.1387200517784068, -0.0563676045856078, -0.0960643850922648, -0.1996284517450904,
	28.5371841910889792, -1.5836024998148992, 1.5406092954799075, -0.4558518694548254, -1.8551187493792895, -1.3782719025235832, -1.5168488857711326, -0.7405924446973926, -0.8142508426976500, -0.2450914053403723, 0.2678014070941270, -0.1166466077947871, 0.2655783416082876, 0.2838525406169257, 0.2519904488638049, 0.1760814730304373, 0.0671378512080532, 0.0190013583624956, -0.1422058757516072, -0.0725657756731484,
	33.9258772068375904, -10.0068930538509786, 0.9457554284570243, -1.6200078631922765, -0.5989024495158525, 0.1702403561614645, -0.9845140521415360, 0.4659582193525058, -0.3268159779790842, 0.3703537939368979, -0.1626080134826259, 0.1326173374267389, 0.1818892430896318, -0.0596473985888782, 0.0435794131483659, 0.0005329359993029, 0.0576035723545228, -0.0245980069042604, 0.0081389357228590, 0.0267039471116625,
	26.2621482415569503, -6.4773222698827775, 1.3128218408965076, 0.7288468455827805, -0.7535472263682939, 0.0238643875933916, -0.8759312080042479, 0.0532738051821737, -0.2257641705679743, -0.0966180453638218, -0.1912281405626702, -0.2296098859851452, 0.1291459052130336, -0.2519470954648898, -0.0109206895192246, -0.1587349666941876, -0.0560094077150285, -0.1316947654398732, -0.0791813087034405, -0.0172268495159880
};

double cm3[M * D] = {
	13.3674466102845599, 4.4714576681447440, 1.5840641609862480, 0.9492501659292747, 1.3406586391683253, 0.6208870715344171, 0.6730949369169488, 0.6368233544823273, 0.5077540427180633, 0.4390874908481791, 0.3748181382504665, 0.4212816802090999, 0.2531309446690736, 0.2702446712955703, 0.2003923838323047, 0.1574918923269883, 0.1423117110466286, 0.1688068391998194, 0.1742281009625675, 0.1592253925663499,
	8.4083544227185030, 3.1105121399820987, 1.0823336178322607, 2.4021330438730315, 0.8133111645628794, 0.8573145141678069, 0.6474646671102667, 0.5410972173732854, 0.5437100287382577, 0.4248685818679939, 0.2917206885739045, 0.3397585001378660, 0.3289597056619878, 0.2410891991428425, 0.2868696723874040, 0.2873334515475635, 0.1567679131468552, 0.1535056732057201, 0.1312071736374050, 0.1202212386602365,
	5.8919788830722837, 2.3076766138289679, 1.2065185134545002, 0.7932681804730545, 0.4613171507334051, 0.3499400472424909, 0.3943516609407509, 0.3487979207130171, 0.3587162053513190, 0.1602676598038341, 0.2275194479062348, 0.2912558500683287, 0.2379499778990490, 0.2015664603424947, 0.3106742167909458, 0.2036926279205993, 0.2001435881571367, 0.1403142183566408, 0.1790171393225275, 0.1344468620770594,
	14.0917252715241830, 1.3843322820769259, 2.9806550674092085, 1.1410223545529354, 0.6865373723313917, 0.7532095758799713, 0.7781095947819066, 0.5995881719486061, 0.5155164900111291, 0.4984055805312934, 0.3948942107411236, 0.2911509091821819, 0.3032324066898171, 0.2565762359241183, 0.2437260310093817, 0.2069217288958942, 0.1730987912354897, 0.1710384272538745, 0.1511883894663471, 0.1021499473420368,
	17.4414558370738177, 7.0337564932127847, 3.4956160517034105, 2.3785123414137797, 2.4679135885917658, 0.9224439862441633, 0.9555203664829568, 1.1891109311278441, 0.7802103541342415, 0.4436677550550312, 0.3013583775677777, 0.2589468728600082, 0.2695670339110893, 0.2235700594972515, 0.1579895178938199, 0.1326476273226401, 0.1090506282225816, 0.1333688573360044, 0.1343783828705432, 0.1219140938289170,
};


// *******************************************************
// jounsup
double value4[IDENTIFY_NUM] = {1032.0406869003563770, 1036.5379772133842380, 1105.9968915906181337, 1062.6823158913907719};
double p4[M] = {0.3103777857156240, 0.1823463364671656, 0.1045165316131604, 0.1174374089105467, 0.2853219372935022};
double mu4[M * D] = {
	46.8882196394096340, -1.3648084442781705, -2.6296813254814566, 0.2192438279177442, -0.8604673065470456, 0.1282872860107342, -0.3132773014006176, -0.2690766616848026, -0.4166116626408662, -0.8008800790650060, -0.3419632925167987, -0.1315364620953722, -0.2719456889042975, -0.1322747992554810, -0.2154735412384072, 0.0067076164053954, -0.0590501667550824, -0.1054400174776782, 0.0413634163021415, -0.0679302075328227,
	43.3782624905526575, -2.8090116980091393, -1.2238535833356399, 2.2424142254903385, -1.0967598831268091, -1.5131058548389440, -0.7167978607240824, -0.0521323309439547, 0.2276111396650690, -0.3140171420739108, -0.6942049534286045, -0.4513456066575169, -0.3747956106315772, 0.0977767792892051, -0.1995163111415909, 0.0184392392792680, -0.0453668150283080, -0.2049040493328449, -0.1367495685125159, -0.2334016275574943,
	32.9506306374000033, 1.3872755851006262, 0.9339752842286353, 0.2073146506212891, -1.0159753502668429, -1.9196400354974338, -0.7624615406081080, 0.1345974016155920, -0.0282049541359619, -0.2756460060235950, -0.2973354660723865, -0.4158343301254927, -0.2389580340725179, -0.0732842690570374, -0.2380610511960331, -0.1989060799480615, -0.1012518570127654, -0.2086631934944814, -0.1757627410251971, -0.0410068313178106,
	47.5798867553828799, -9.1121998891930360, 2.3132287401018283, -2.7398552671382324, -0.0378001125663960, -0.6140970315720296, -0.1484238583890338, 0.1534911921214902, -0.1982033857360861, 0.3784560762038101, -0.3094887960286442, 0.2141202874237763, -0.1069586174771563, 0.2828405033322747, -0.0090661062026985, 0.1418352364386370, -0.1107805455248210, 0.1107307908291989, -0.0982851178535451, 0.0840230035284418,
	34.1027925324322325, -6.2232397698562956, -0.3543635578526645, 0.3220007592371665, -0.4687021646161222, 0.1328251398426770, -0.6225830094648011, 0.0023510818488768, -0.0124197270172366, -0.0934887975705584, 0.0479732955750593, -0.2150961779674415, -0.0821046011560560, -0.0647782977480838, -0.0331108613380263, -0.1922726142156726, -0.0265583041248695, -0.0226881565890770, -0.1341741514609360, -0.0023407007960664,
};

double cm4[M * D] = {
	18.1455911421571727, 3.8646633491553253, 1.2546878106969555, 0.6382848621320453, 0.8827230815827086, 0.5057772320531515, 0.4051289707746752, 0.2785914790163116, 0.3292040134894871, 0.2553109031447389, 0.2116897664683898, 0.3188330067525023, 0.1670212788165419, 0.2078133095524247, 0.1546935205448785, 0.1659454128985835, 0.1019670849916819, 0.1132992619568028, 0.1010415364098296, 0.0840410925647581,
	12.7261542707283297, 2.1433352610371648, 1.3779108739481933, 0.5652628060708951, 0.5962804259371186, 0.8725109366905821, 0.2802215016885495, 0.2850512314343936, 0.4829546690510292, 0.3164637059013858, 0.2432989469887738, 0.1971402026445008, 0.2461228253470952, 0.1285013239965560, 0.1175506225248406, 0.1012845486477097, 0.0909676184951172, 0.0708138687950231, 0.0719654070001673, 0.0987109912758887,
	8.8790115780341239, 2.0309637451237910, 1.7835064449834133, 0.7749522114823813, 0.3395801045134641, 0.8141387024127390, 0.3711005498954498, 0.2924127757642592, 0.3161300603875645, 0.1815269596381776, 0.1665057633926578, 0.1127564158902653, 0.1405144207317060, 0.1087378867306658, 0.1229553299048121, 0.0728896826363671, 0.1036094083772271, 0.0659547249104089, 0.0509829247963625, 0.0503432601876153,
	16.5333797393705026, 1.4422974518231229, 2.5067746739350740, 1.0641009760940543, 1.1949591158792967, 1.0807621546132484, 1.3460924026676639, 0.8428070494610164, 0.6755990724734152, 0.5120088318770359, 0.5044794298905183, 0.3831476891905439, 0.3268758311436903, 0.2601636243597125, 0.2339297930208590, 0.2171285181702566, 0.1843424802631186, 0.1535951346697151, 0.1142948428867862, 0.1103470806336490,
	64.8199889648103635, 12.7785051964956011, 3.7976904394084943, 2.0809677216991127, 1.2170402144000341, 1.2220785757525088, 0.9590927227624620, 0.8280385154813075, 0.5865082820181064, 0.4949923818185094, 0.3887252744623581, 0.3837767074817283, 0.3586104537955109, 0.2829713110235528, 0.2233138269483604, 0.2289462855272302, 0.1557301662488349, 0.1357153585412627, 0.1185594004970393, 0.0984906306701166,
};


void loadVoiceModel34() {
	int i;
	// model 3
	voiceprint[MODEL3].voice_mdl.bValued = TRUE;
	voiceprint[MODEL3].voice_mdl.frame_num = FRAME_NUM;
	voiceprint[MODEL3].voice_mdl.percent = PERCENT;
	voiceprint[MODEL3].voice_mdl.m = M;
	for (i = 0; i < IDENTIFY_NUM; i++) {
		voiceprint[MODEL3].voice_mdl.value[i][BUILD] = value3[i];
		voiceprint[MODEL3].voice_mdl.value[i][IDENTIFY] = 0;
	}

	voiceprint[MODEL3].voice_mdl.gmm.p = p3;
	voiceprint[MODEL3].voice_mdl.gmm.mu = (double **)malloc(M * sizeof(double *));
	assert(voiceprint[MODEL3].voice_mdl.gmm.mu != NULL);
	voiceprint[MODEL3].voice_mdl.gmm.cMatrix = (double **)malloc(M * sizeof(double *));
	assert(voiceprint[MODEL3].voice_mdl.gmm.cMatrix != NULL);
	for (i = 0; i < M; i++) {
		voiceprint[MODEL3].voice_mdl.gmm.mu[i] = mu3 + D * i;
		voiceprint[MODEL3].voice_mdl.gmm.cMatrix[i] = cm3 + D * i;
	}

	// model 4
	voiceprint[MODEL4].voice_mdl.bValued = TRUE;
	voiceprint[MODEL4].voice_mdl.frame_num = FRAME_NUM;
	voiceprint[MODEL4].voice_mdl.percent = PERCENT;
	voiceprint[MODEL4].voice_mdl.m = M;
	for (i = 0; i < IDENTIFY_NUM; i++) {
		voiceprint[MODEL4].voice_mdl.value[i][BUILD] = value4[i];
		voiceprint[MODEL4].voice_mdl.value[i][IDENTIFY] = 0;
	}

	voiceprint[MODEL4].voice_mdl.gmm.p = p4;
	voiceprint[MODEL4].voice_mdl.gmm.mu = (double **)malloc(M * sizeof(double *));
	assert(voiceprint[MODEL4].voice_mdl.gmm.mu != NULL);
	voiceprint[MODEL4].voice_mdl.gmm.cMatrix = (double **)malloc(M * sizeof(double *));
	assert(voiceprint[MODEL4].voice_mdl.gmm.cMatrix != NULL);
	for (i = 0; i < M; i++) {
		voiceprint[MODEL4].voice_mdl.gmm.mu[i] = mu4 + D * i;
		voiceprint[MODEL4].voice_mdl.gmm.cMatrix[i] = cm4 + D * i;
	}
}

void printGMM(VOICE_MODEL vm) {
	int i, j;

	printf("value: ");
	for (i = 0; i < IDENTIFY_NUM; i++) {
		printf("%.16f, ", vm.value[i][BUILD]);
	}
	printf("\n");

	printf("p: ");
	for (i = 0; i < M; i++) {
		printf("%.16f, ", vm.gmm.p[i]);
	}
	printf("\n");

	printf("mu: \n");
	for (i = 0; i < M; i++) {
		for (j = 0; j < D; j++) {
			printf("%.16f, ", vm.gmm.mu[i][j]);
		}
		printf("\n");
	}
	printf("\n");

	printf("cMatrix: \n");
	for (i = 0; i < M; i++) {
		for (j = 0; j < D; j++) {
			printf("%.16f, ", vm.gmm.cMatrix[i][j]);
		}
		printf("\n");
	}
	printf("\n");
}

int main() {
	
	// initialize DSP board
  	DSP_Init();

	// call StartUp for application specific code
	// defined in each application directory
	StartUp();
	
	AIC3106_write_reg(AIC3106_REG0_LINE1L_LEFT_ADC, 0x7C); // input 1 off, ADC powered up
	AIC3106_write_reg(AIC3106_REG0_LINE1R_RIGHT_ADC, 0x7C); // input 1 off, ADC powered up
	AIC3106_write_reg(AIC3106_REG0_MIC3LR_LEFT_ADC, 0x0F); // mic input left 0dB(L to L)
	AIC3106_write_reg(AIC3106_REG0_MIC3LR_RIGHT_ADC, 0xF0); // mic input right 0dB(R to R)

	Init_UART2(115200);

	VoicePrintInit(&voiceprint[0]);
	VoicePrintInit(&voiceprint[1]);

	printf("\n");
	printf("Loading preset models...\n");
	loadVoiceModel34();
	printf("Loaded.\n");

	while(1) {
		if (status == STANDBY) {
			while(!IsDataReady_UART2()) {
				;
			}
			int value = Read_UART2();
			printf("Received command: %d\n", value);
			if (value >= STANDBY && value <= IDENTIFYING) {
				if (value == IDENTIFYRECORDING || value == RECORDING1 || value == RECORDING2) {
					printf("\nPlease start speaking...\n");
				}
				status = value;
			}
		}

		if (status == BUILDMODEL1 || status == BUILDMODEL2) {
			int idx = 0;
			if (status == BUILDMODEL1) {
				idx = 0;
			} else if (status == BUILDMODEL2) {
				idx = 1;
			}

			// free old model
			if (voiceprint[idx].voice_mdl.bValued) {
				voiceprint[idx].voice_mdl.bValued = FALSE;
				FreeGMM(&voiceprint[idx].voice_mdl.gmm);
			}

			if (GenerateGMM(&voiceprint[idx])) {
				voiceprint[idx].voice_mdl.bValued = TRUE;
				printf("GMM Model Created.\n");
				printGMM(voiceprint[idx].voice_mdl);
			}
			else {
				printf("Failed to create GMM Model.\n");
			}
			status = STANDBY;
		} else if (status == IDENTIFYING) {
			printf("Identifying...\n");
			int i;
			TBYTE * pRawVoice = (TBYTE *)pVoiceBuffer;
			double **MFCC = (double **)mmalloc(IDENTIFY_FRAME_NUM * sizeof(double *));
			assert(MFCC != NULL);
			for (i = 0; i < IDENTIFY_FRAME_NUM; ++i) {
				MFCC[i] = (double *)mmalloc(D * sizeof(double));
				assert(MFCC[i] != NULL);
			}
			if (voiceToMFCC(pRawVoice, IDENTIFY_BUFF_NUM * BUFFLEN, MFCC, IDENTIFY_FRAME_NUM)) {
				IdentifyGMM(MFCC, &voiceprint[MODEL3]);
				IdentifyGMM(MFCC, &voiceprint[MODEL4]);
				if (voiceprint[0].voice_mdl.bValued) {
					IdentifyGMM(MFCC, &voiceprint[0]);
				}
				if (voiceprint[1].voice_mdl.bValued) {
					IdentifyGMM(MFCC, &voiceprint[1]);
				}
				for (i = 0; i < IDENTIFY_FRAME_NUM; ++i) {
					free(MFCC[i]);
				}
				free(MFCC);
			} else {
				printf("MFCC failed.\n");
				for (i = 0; i < IDENTIFY_FRAME_NUM; ++i) {
					free(MFCC[i]);
				}
				free(MFCC);
			}

			int res = IdentifyResult();
			if (res == -1) {
				printf("No registered user found.\n");
				while(!IsTxReady_UART2()) {
					;
				}
				Write_UART2(100);
			} else {
				printf("Recognized %d\n", res + 1);
				while(!IsTxReady_UART2()) {
					;
				}
				Write_UART2(111 + res);
				// 111 model 0
				// 112 model 1
				// 113 model 2
				// 114 model 3
			}
			status = IDENTIFYRECORDING;
			printf("\nPlease start speaking...\n");
		}
	}
}


